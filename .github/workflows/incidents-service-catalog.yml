name: Update swagger.yaml repository service-catalog

on:
  push:
    paths:
      - 'services/github.com/beyondtrust/incidents/swagger-docs/swagger.yaml'
permissions:
  contents: write
  pull-requests: write
  
env:
  REPO_NAME: service-catalog
  REPO_PATH: temp-repo
  SWAGGER_PATH: services/github.com/beyondtrust/incidents/swagger-docs
  TEMP_BRANCH_NAME: temp-update-swagger-$(date +'%s')

jobs:
  update-swagger:
    runs-on: ubuntu-latest
    
    steps:
    - name: Clone incidents repository
      uses: actions/checkout@v3

    - name: Clone service-catalog repository
      uses: actions/checkout@v3
      with:
        repository: ejimenez/${{ env.REPO_NAME }}
        token: ${{ secrets.SERVICE_CATALOG_OPEN_PR_TOKEN }}
        path: ${{ env.REPO_PATH }}

    - name: Copy swagger.yaml to repository service-catalog
      run: |
        cp ${{ env.SWAGGER_PATH }}/swagger.yaml ${{ env.REPO_PATH }}/swagger.yaml

    - name: Commit changes to new branch in service-catalog repository
      run: |
        cd ${{ env.REPO_PATH }}
        git config user.email "ejimenez@beyondtrust.com"
        git config user.name "Emanuel Jimenez"
        git checkout -b update-swagger-${{ github.run_id }} # Crear y cambiar a una nueva rama
        git add swagger.yaml
        git commit -m "Update swagger.yaml"
        git push origin update-swagger-${{ github.run_id }}

    - name: Create Pull Request using GitHub CLI
      run: |
        gh pr create --repo ejimenez/${{ env.REPO_NAME }} \
          --base main \
          --head update-swagger-${{ github.run_id }} \
          --title "Update de swagger.yaml" \
          --body "Updated file swagger.yaml from incidents repository." \
          --reviewer ejimenez
      env:
        GH_TOKEN: ${{ secrets.SERVICE_CATALOG_OPEN_PR_TOKEN }}
